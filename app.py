import streamlit as st
import requests
from collections import defaultdict

st.set_page_config(page_title="ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?", page_icon="ğŸ¬", layout="centered")

# =========================
# TMDB ì„¤ì •
# =========================
POSTER_BASE = "https://image.tmdb.org/t/p/w500"

GENRES = {
    "ì•¡ì…˜": 28,
    "ì½”ë¯¸ë””": 35,
    "ë“œë¼ë§ˆ": 18,
    "SF": 878,
    "ë¡œë§¨ìŠ¤": 10749,
    "íŒíƒ€ì§€": 14,
}

@st.cache_data(show_spinner=False, ttl=60 * 30)
def fetch_popular_movies_by_genre(api_key: str, genre_id: int, language: str = "ko-KR", top_n: int = 5):
    """TMDB discover APIë¡œ ì¥ë¥´ ì¸ê¸° ì˜í™” ê°€ì ¸ì˜¤ê¸°"""
    url = "https://api.themoviedb.org/3/discover/movie"
    params = {
        "api_key": api_key,
        "with_genres": genre_id,
        "language": language,
        "sort_by": "popularity.desc",
        "include_adult": "false",
        "page": 1,
    }
    r = requests.get(url, params=params, timeout=15)
    r.raise_for_status()
    data = r.json()
    results = data.get("results", [])[:top_n]
    return results

def analyze_answers(answers: dict):
    """
    ì‚¬ìš©ì ë‹µë³€ì„ ì ìˆ˜í™”í•´ì„œ ê°€ì¥ ì í•©í•œ ì¥ë¥´ë¥¼ ê²°ì •.
    answers: {"q1": "...", "q2": "...", ...}
    """
    score = defaultdict(int)
    reasons = defaultdict(list)

    def add(genre, pts, reason):
        score[genre] += pts
        reasons[genre].append(reason)

    # 1. ì£¼ë§ì— ê°€ì¥ í•˜ê³  ì‹¶ì€ ê²ƒì€?
    a = answers["q1"]
    if a == "ì§‘ì—ì„œ íœ´ì‹":
        add("ë“œë¼ë§ˆ", 2, "ì£¼ë§ì—” ì¡°ìš©íˆ ì‰¬ë©° ê°ì •ì„  ìˆëŠ” ì´ì•¼ê¸°ì™€ ì˜ ë§ì•„ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ì”ì”í•œ ë¶„ìœ„ê¸°ì˜ ë¡œë§¨ìŠ¤ë„ ì˜ ì¦ê¸¸ íƒ€ì…ì´ì—ìš”.")
    elif a == "ì¹œêµ¬ì™€ ë†€ê¸°":
        add("ì½”ë¯¸ë””", 2, "ì¹œêµ¬ì™€ ì›ƒê³  ë– ë“œëŠ” ì—ë„ˆì§€ê°€ ì½”ë¯¸ë”” ì·¨í–¥ê³¼ ì°°ë–¡ì´ì—ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ì‚¬ëŒ ì‚¬ì´ ì¼€ë¯¸ê°€ ì¤‘ìš”í•œ ë¡œë§¨ìŠ¤ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”.")
    elif a == "ìƒˆë¡œìš´ ê³³ íƒí—˜":
        add("ì•¡ì…˜", 2, "ìƒˆë¡œìš´ ê³³ì„ íƒí—˜í•˜ëŠ” ì„±í–¥ì´ ì–´ë“œë²¤ì²˜ ê°ì„±ê³¼ ë§ì•„ìš”.")
        add("íŒíƒ€ì§€", 1, "ë‚¯ì„  ì„¸ê³„ë¥¼ ì¢‹ì•„í•œë‹¤ë©´ íŒíƒ€ì§€ë„ ì˜ ë§ì•„ìš”.")
    elif a == "í˜¼ì ì·¨ë¯¸ìƒí™œ":
        add("SF", 2, "í˜¼ì ëª°ì…í•˜ëŠ” ì·¨ë¯¸ëŠ” ì„¸ê³„ê´€ì— ë¹ ì§€ëŠ” SFì™€ ì˜ ì–´ìš¸ë ¤ìš”.")
        add("íŒíƒ€ì§€", 1, "ìƒìƒë ¥ì„ ìê·¹í•˜ëŠ” íŒíƒ€ì§€ë„ ì·¨í–¥ì¼ ìˆ˜ ìˆì–´ìš”.")

    # 2. ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ìœ¼ë©´?
    a = answers["q2"]
    if a == "í˜¼ì ìˆê¸°":
        add("ë“œë¼ë§ˆ", 2, "ê°ì • ì •ë¦¬ì— ì§‘ì¤‘í•˜ëŠ” í¸ì´ë¼ ë“œë¼ë§ˆê°€ ì˜ ë§ì•„ìš”.")
        add("SF", 1, "í˜¼ì ëª°ì…í•˜ëŠ” ì¥ë¥´(SF)ë¡œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í’€ê¸°ë„ í•´ìš”.")
    elif a == "ìˆ˜ë‹¤ ë–¨ê¸°":
        add("ì½”ë¯¸ë””", 2, "ê°€ë²¼ìš´ ëŒ€í™”/ì›ƒìŒìœ¼ë¡œ í‘¸ëŠ” íƒ€ì…ì´ë¼ ì½”ë¯¸ë””ê°€ ì˜ ë§ì•„ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ê´€ê³„ ì¤‘ì‹¬ ì´ì•¼ê¸°ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ì»¤ìš”.")
    elif a == "ìš´ë™í•˜ê¸°":
        add("ì•¡ì…˜", 2, "ëª¸ì„ ì›€ì§ì—¬ í‘¸ëŠ” ì—ë„ˆì§€! ì•¡ì…˜ ê°ì„±ê³¼ ë”±ì´ì—ìš”.")
        add("SF", 1, "ìŠ¤ì¼€ì¼ í° ì¥ë©´/ëª°ì…ê° ìˆëŠ” ì¥ë¥´ë„ ì„ í˜¸í•  ìˆ˜ ìˆì–´ìš”.")
    elif a == "ë§›ìˆëŠ” ê±° ë¨¹ê¸°":
        add("ì½”ë¯¸ë””", 2, "ì†Œí™•í–‰ ìŠ¤íƒ€ì¼ì´ë¼ ë¶€ë‹´ ì—†ì´ ì›ƒëŠ” ì½”ë¯¸ë””ê°€ ì˜ ë§ì•„ìš”.")
        add("ë“œë¼ë§ˆ", 1, "ë”°ëœ»í•œ ê°ì„±ì˜ ë“œë¼ë§ˆë„ ì˜ ë§ì„ ìˆ˜ ìˆì–´ìš”.")

    # 3. ì˜í™”ì—ì„œ ì¤‘ìš”í•œ ê²ƒì€?
    a = answers["q3"]
    if a == "ê°ë™ ìŠ¤í† ë¦¬":
        add("ë“œë¼ë§ˆ", 3, "ìŠ¤í† ë¦¬ ì¤‘ì‹¬ ê°ë™ì„ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ë³´ëŠ” íƒ€ì…ì´ì—ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ê°ì •ì„ ì´ ì¤‘ìš”í•œ ë¡œë§¨ìŠ¤ë„ ì˜ ë§ì•„ìš”.")
    elif a == "ì‹œê°ì  ì˜ìƒë¯¸":
        add("SF", 3, "ë¹„ì£¼ì–¼ ìŠ¤ì¼€ì¼ê³¼ ì¥ë©´ë¯¸ê°€ ê°•í•œ SFê°€ ìµœì ì´ì—ìš”.")
        add("íŒíƒ€ì§€", 2, "í™”ë ¤í•œ ì„¸ê³„ê´€ì˜ íŒíƒ€ì§€ë„ ë§Œì¡±ë„ê°€ ë†’ì•„ìš”.")
    elif a == "ê¹Šì€ ë©”ì‹œì§€":
        add("SF", 2, "â€˜ë§Œì•½ì—?â€™ë¥¼ ë˜ì§€ëŠ” SFì˜ ë©”ì‹œì§€ê°€ ì˜ ë§ì•„ìš”.")
        add("ë“œë¼ë§ˆ", 2, "í˜„ì‹¤ì„ ë¹„ì¶”ëŠ” ë“œë¼ë§ˆì˜ ë©”ì‹œì§€ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ì»¤ìš”.")
    elif a == "ì›ƒëŠ” ì¬ë¯¸":
        add("ì½”ë¯¸ë””", 3, "í™•ì‹¤í•œ â€˜ì›ƒìŒâ€™ì´ ìµœìš°ì„ ì´ë¼ ì½”ë¯¸ë””ê°€ ì •ë‹µì´ì—ìš”.")

    # 4. ì—¬í–‰ ìŠ¤íƒ€ì¼?
    a = answers["q4"]
    if a == "ê³„íšì ":
        add("ë“œë¼ë§ˆ", 1, "íë¦„ì„ ì„¤ê³„í•˜ëŠ” ì·¨í–¥ì´ë¼ ì„œì‚¬ê°€ íƒ„íƒ„í•œ ì¥ë¥´ì™€ ì˜ ë§ì•„ìš”.")
        add("SF", 1, "ë…¼ë¦¬/êµ¬ì¡° ìˆëŠ” ì„¸ê³„ê´€(SF)ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”.")
    elif a == "ì¦‰í¥ì ":
        add("ì•¡ì…˜", 1, "ì¦‰í¥ì  ì„ íƒì€ ì–´ë“œë²¤ì²˜ ë¬´ë“œì™€ ì–´ìš¸ë ¤ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ì˜ˆìƒì¹˜ ëª»í•œ ë§Œë‚¨/ì „ê°œë¥¼ ì¢‹ì•„í•œë‹¤ë©´ ë¡œë§¨ìŠ¤ë„ ì°°ë–¡ì´ì—ìš”.")
        add("ì½”ë¯¸ë””", 1, "ì¦‰í¥ì˜ í•´í”„ë‹ì€ ì½”ë¯¸ë”” ê°ì„±ë„ ì˜ ë§ì•„ìš”.")
    elif a == "ì•¡í‹°ë¹„í‹°":
        add("ì•¡ì…˜", 3, "ì›€ì§ì„/ìŠ¤ë¦´ì„ ì¦ê¸°ëŠ” íƒ€ì…ì´ë¼ ì•¡ì…˜ì´ ê°€ì¥ ì˜ ë§ì•„ìš”.")
    elif a == "íë§":
        add("ë“œë¼ë§ˆ", 2, "ì”ì”í•˜ê³  ë”°ëœ»í•œ ë“œë¼ë§ˆë¡œ íë§í•˜ëŠ” íƒ€ì…ì´ì—ìš”.")
        add("ë¡œë§¨ìŠ¤", 2, "ì„¤ë ˆëŠ” ë¡œë§¨ìŠ¤ë¡œ ë§ˆìŒì„ ì±„ìš°ëŠ” ê²ƒë„ ì˜ ë§ì•„ìš”.")

    # 5. ì¹œêµ¬ ì‚¬ì´ì—ì„œ ë‚˜ëŠ”?
    a = answers["q5"]
    if a == "ë“£ëŠ” ì—­í• ":
        add("ë“œë¼ë§ˆ", 2, "ê´€ì°°/ê³µê°ë ¥ì´ ë†’ì€ í¸ì´ë¼ ë“œë¼ë§ˆ ê°ì„±ê³¼ ì˜ ë§ì•„ìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ê°ì •ì„  ì„¬ì„¸í•œ ë¡œë§¨ìŠ¤ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”.")
    elif a == "ì£¼ë„í•˜ê¸°":
        add("ì•¡ì…˜", 2, "ìƒí™©ì„ ì´ë„ëŠ” íƒ€ì…ì´ë¼ ì£¼ì¸ê³µ ê°ì„±(ì•¡ì…˜)ê³¼ ë§ì•„ìš”.")
        add("SF", 1, "â€˜ì „ëµ/íŒë‹¨â€™ì´ í•„ìš”í•œ ì¥ë¥´ë„ ì˜ ë§ì„ ìˆ˜ ìˆì–´ìš”.")
    elif a == "ë¶„ìœ„ê¸° ë©”ì´ì»¤":
        add("ì½”ë¯¸ë””", 2, "ë¶„ìœ„ê¸° ë©”ì´ì»¤ëŠ” ì½”ë¯¸ë”” ì—ë„ˆì§€ ê·¸ ìì²´ì˜ˆìš”.")
        add("ë¡œë§¨ìŠ¤", 1, "ì¼€ë¯¸/ê´€ê³„ ì¤‘ì‹¬ì˜ ë¡œë§¨ìŠ¤ë„ ì˜ ë§ì„ ìˆ˜ ìˆì–´ìš”.")
    elif a == "í•„ìš”í•  ë•Œ ë‚˜íƒ€ë‚¨":
        add("SF", 2, "í•œ ë°©ì— ì„íŒ©íŠ¸! ë…íŠ¹í•œ ë§¤ë ¥ì€ SF/íŒíƒ€ì§€ì™€ ì˜ ë§ì•„ìš”.")
        add("íŒíƒ€ì§€", 2, "ì‹ ë¹„ë¡œìš´ â€˜í‚¤ í”Œë ˆì´ì–´â€™ ê°ì„±ì´ë¼ íŒíƒ€ì§€ë„ ì°°ë–¡ì´ì—ìš”.")

    # ìµœì¢… ì¥ë¥´ ê²°ì • (ë™ì ì´ë©´ ìš°ì„ ìˆœìœ„ë¡œ ê²°ì •)
    priority = ["ë“œë¼ë§ˆ", "ë¡œë§¨ìŠ¤", "ì•¡ì…˜", "ì½”ë¯¸ë””", "SF", "íŒíƒ€ì§€"]
    best_score = max(score.values()) if score else 0
    candidates = [g for g, s in score.items() if s == best_score]
    chosen = sorted(candidates, key=lambda g: priority.index(g) if g in priority else 999)[0] if candidates else "ë“œë¼ë§ˆ"

    # ì¶”ì²œ ì´ìœ : í•´ë‹¹ ì¥ë¥´ reasons ì¤‘ ìƒìœ„ 2ê°œë§Œ ìš”ì•½
    chosen_reasons = reasons[chosen][:2]
    reason_text = " ".join(chosen_reasons) if chosen_reasons else "ë‹¹ì‹ ì˜ ì„ íƒì´ ì´ ì¥ë¥´ì˜ ë§¤ë ¥ê³¼ ì˜ ë§ì•„ìš”."

    return chosen, reason_text, dict(score)

# =========================
# UI
# =========================
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write("ê°„ë‹¨í•œ ì§ˆë¬¸ 5ê°œë¡œ ë‹¹ì‹ ì˜ ë¬´ë“œì— ë§ëŠ” ì˜í™” ì¥ë¥´ë¥¼ ì°¾ê³ , TMDBì—ì„œ ì¸ê¸° ì˜í™” 5í¸ì„ ì¶”ì²œí•´ë“œë ¤ìš”!")

st.sidebar.header("ğŸ”‘ TMDB ì„¤ì •")
api_key = st.sidebar.text_input("TMDB API Key", type="password", placeholder="ì—¬ê¸°ì— API Key ì…ë ¥")

st.divider()

# ì§ˆë¬¸ë“¤
q1 = st.radio(
    "1. ì£¼ë§ì— ê°€ì¥ í•˜ê³  ì‹¶ì€ ê²ƒì€?",
    ["ì§‘ì—ì„œ íœ´ì‹", "ì¹œêµ¬ì™€ ë†€ê¸°", "ìƒˆë¡œìš´ ê³³ íƒí—˜", "í˜¼ì ì·¨ë¯¸ìƒí™œ"],
    key="q1"
)
q2 = st.radio(
    "2. ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ìœ¼ë©´?",
    ["í˜¼ì ìˆê¸°", "ìˆ˜ë‹¤ ë–¨ê¸°", "ìš´ë™í•˜ê¸°", "ë§›ìˆëŠ” ê±° ë¨¹ê¸°"],
    key="q2"
)
q3 = st.radio(
    "3. ì˜í™”ì—ì„œ ì¤‘ìš”í•œ ê²ƒì€?",
    ["ê°ë™ ìŠ¤í† ë¦¬", "ì‹œê°ì  ì˜ìƒë¯¸", "ê¹Šì€ ë©”ì‹œì§€", "ì›ƒëŠ” ì¬ë¯¸"],
    key="q3"
)
q4 = st.radio(
    "4. ì—¬í–‰ ìŠ¤íƒ€ì¼?",
    ["ê³„íšì ", "ì¦‰í¥ì ", "ì•¡í‹°ë¹„í‹°", "íë§"],
    key="q4"
)
q5 = st.radio(
    "5. ì¹œêµ¬ ì‚¬ì´ì—ì„œ ë‚˜ëŠ”?",
    ["ë“£ëŠ” ì—­í• ", "ì£¼ë„í•˜ê¸°", "ë¶„ìœ„ê¸° ë©”ì´ì»¤", "í•„ìš”í•  ë•Œ ë‚˜íƒ€ë‚¨"],
    key="q5"
)

st.divider()

if st.button("ê²°ê³¼ ë³´ê¸°", type="primary"):
    if not api_key.strip():
        st.error("ì‚¬ì´ë“œë°”ì— TMDB API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”!")
        st.stop()

    answers = {"q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5}
    chosen_genre, reason_text, score_map = analyze_answers(answers)
    genre_id = GENRES[chosen_genre]

    with st.spinner("ë¶„ì„ ì¤‘..."):
        try:
            movies = fetch_popular_movies_by_genre(api_key=api_key.strip(), genre_id=genre_id, top_n=5)
        except requests.HTTPError as e:
            st.error(f"TMDB API ìš”ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”. API Keyê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.\n\nì—ëŸ¬: {e}")
            st.stop()
        except requests.RequestException as e:
            st.error(f"ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ TMDBì— ì—°ê²°í•˜ì§€ ëª»í–ˆì–´ìš”.\n\nì—ëŸ¬: {e}")
            st.stop()

    st.subheader("ğŸ§  ë¶„ì„ ê²°ê³¼")
    st.write(f"ë‹¹ì‹ ì—ê²Œ ê°€ì¥ ì˜ ë§ëŠ” ì¥ë¥´ëŠ” **{chosen_genre}** ì…ë‹ˆë‹¤.")
    st.caption(f"ì¶”ì²œ ì´ìœ : {reason_text}")

    # (ì›í•˜ë©´ ë””ë²„ê¹…/ì„¤ëª…ìš©ìœ¼ë¡œ ì ìˆ˜ ê³µê°œ)
    with st.expander("ì ìˆ˜ ë³´ê¸°(ì„ íƒ)"):
        st.json(score_map)

    st.subheader("ğŸ¿ ì¶”ì²œ ì˜í™” 5í¸")
    if not movies:
        st.warning("í•´ë‹¹ ì¥ë¥´ì—ì„œ ì¶”ì²œí•  ì˜í™”ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì¥ë¥´ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!")
    else:
        for m in movies:
            title = m.get("title") or m.get("name") or "ì œëª© ì—†ìŒ"
            vote = m.get("vote_average", 0)
            overview = m.get("overview") or "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ì–´ìš”."
            poster_path = m.get("poster_path")
            poster_url = f"{POSTER_BASE}{poster_path}" if poster_path else None

            # ì˜í™”ë³„ ì¶”ì²œ ì´ìœ (ê°„ë‹¨)
            per_movie_reason = f"ë‹¹ì‹ ì˜ ë‹µë³€ì´ **{chosen_genre}** ê°ì„±ê³¼ ì˜ ë§ì•„ì„œ, ì´ ì¥ë¥´ì—ì„œ íŠ¹íˆ ì¸ê¸° ìˆëŠ” ì‘í’ˆì„ ê³¨ëì–´ìš”."

            card = st.container(border=True)
            with card:
                cols = st.columns([1, 2])
                with cols[0]:
                    if poster_url:
                        st.image(poster_url, use_container_width=True)
                    else:
                        st.caption("í¬ìŠ¤í„° ì—†ìŒ")
                with cols[1]:
                    st.markdown(f"### {title}")
                    st.write(f"â­ í‰ì : **{vote:.1f}**")
                    st.write(overview)
                    st.caption(f"ğŸ’¡ ì´ ì˜í™”ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ : {per_movie_reason}")

